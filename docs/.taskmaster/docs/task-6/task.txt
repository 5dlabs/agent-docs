# Task ID: 5
# Title: Streamable HTTP Response Enhancement (JSON-only MVP)
# Status: pending
# Dependencies: 3
# Priority: medium
# Description: Implement enhancements to the MCP 2025-06-18 Streamable HTTP transport focusing on JSON-only POST responses for MVP. Ensure correct headers, error mapping, and logging. Streaming (SSE) is out of scope.
# Details:
1. Unified Endpoint Behavior
   • Ensure `/mcp` POST returns JSON body with required headers.
   • Ensure non-POST (e.g., GET) returns 405 Method Not Allowed.

2. Headers
   • Include `MCP-Protocol-Version: 2025-06-18` and `Mcp-Session-Id` in responses.

3. Error Model
   • Map transport-layer failures to HTTP codes (400, 401, 403, 404, 405, 413, 429, 500).
   • JSON-RPC 2.0 compliant error objects for application errors.

4. Logging
   • Structured logs include request id, session id, protocol version.

5. Configuration Surface (MVP)
   • None required beyond existing server configuration.

6. Tracing & Metrics
   • Basic counters for requests and errors.

NOTE: Do not re-implement routing or generic JSON-RPC parsing—build on the foundation delivered in Task 2. Streaming is out of scope for MVP.

# Test Strategy:
1. Functional
   • Issue POST requests with Accept: application/json and verify the server returns a normal JSON body with required headers.
   • Issue GET to `/mcp` and verify 405.

2. Headers
   • Verify required headers present in responses.

3. Error Handling
   • Validate correct HTTP status codes and JSON-RPC error objects.

4. Compatibility
   • Confirm behaviour remains stable for clients that advertise only application/json.

5. Concurrency & Isolation
   • Mix various POST requests; ensure no cross-talk between sessions.

# Subtasks:
## 1. Ensure POST-only handling and response headers [pending]
### Dependencies: None
### Description: 
### Details:


## 2. Implement header helpers and error mapping [pending]
### Dependencies: None
### Description: 
### Details:


## 3. Add basic logging for request/session/version [pending]
### Dependencies: None
### Description: 
### Details:


## 4. Add tests for 405 on GET and header presence [pending]
### Dependencies: None
### Description: 
### Details:


## 5. Add simple counters for requests/errors [pending]
### Dependencies: None
### Description: 
### Details:


## 6. Write integration tests for POST-only and error paths [pending]
### Dependencies: None
### Description: 
### Details:


