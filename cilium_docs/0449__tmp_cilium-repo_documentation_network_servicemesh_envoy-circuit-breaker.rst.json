{
  "url": "file:///tmp/cilium-repo/Documentation/network/servicemesh/envoy-circuit-breaker.rst",
  "content": ".. only:: not (epub or latex or html) \n WARNING: You are looking at unreleased Cilium documentation.\nPlease use the official rendered version released here:\nhttps://docs.cilium.io\n \n .. _gs_envoy_circuit_breaker: \n \n L7 Circuit Breaking \n \n Cilium Service Mesh defines a  CiliumClusterwideEnvoyConfig  CRD which allows users\nto set the configuration of the Envoy component built into Cilium agents. \n Circuit breaking is an important pattern for creating resilient microservice applications.\nCircuit breaking allows you to write applications that limit the impact of failures, latency spikes,\nand other undesirable effects of network peculiarities. \n You will configure Circuit breaking rules with  CiliumClusterwideEnvoyConfig  and then test the configuration\nby intentionally “tripping” the circuit breaker in this example. \n Deploy Test Applications \n .. parsed-literal:: \n $ kubectl apply -f \\ |SCM_WEB|\\/examples/kubernetes/servicemesh/envoy/test-application-proxy-circuit-breaker.yaml\n \n The test workloads consist of: \n \n One client Deployment,  fortio-deploy \n One Service,  echo-service \n \n View information about these Pods: \n .. code-block:: shell-session \n $ kubectl get pods --show-labels -o wide\nNAME                             READY   STATUS    RESTARTS   AGE     IP           NODE                       NOMINATED NODE   READINESS GATES   LABELS\necho-service-59557f5857-xh84s    2/2     Running   0          7m37s   10.0.0.125   cilium-control-plane   <none>           <none>            kind=echo,name=echo-service,other=echo,pod-template-hash=59557f5857\nfortio-deploy-687945c6dc-6qnh4   1/1     Running   0          7m37s   10.0.0.109   cilium-control-plane   <none>           <none>            app=fortio,pod-template-hash=687945c6dc\n \n Configuring Envoy Circuit Breaker \n Apply the  envoy-circuit-breaker.yaml  file, which defines a  CiliumClusterwideEnvoyConfig . \n .. parsed-literal:: \n $ kubectl apply -f \\ |SCM_WEB|\\/examples/kubernetes/servicemesh/envoy/envoy-circuit-breaker.yaml\n \n .. include:: warning.rst \n Verify the  CiliumClusterwideEnvoyConfig  was created correctly. \n .. code-block:: shell-session \n $ kubectl get ccec envoy-circuit-breaker -oyaml\napiVersion: cilium.io/v2\nkind: CiliumClusterwideEnvoyConfig\n...\nresources:\n- \"@type\": type.googleapis.com/envoy.config.cluster.v3.Cluster\n  name: \"default/echo-service\"\n  connect_timeout: 5s\n  lb_policy: ROUND_ROBIN\n  type: EDS\n  circuit_breakers:\n    thresholds:\n    - priority: \"DEFAULT\"\n      max_requests: 2\n      max_pending_requests: 1\n  outlier_detection:\n    split_external_local_origin_errors: true\n    consecutive_local_origin_failure: 2\nservices:\n- name: echo-service\n  namespace: default\n \n In the  CiliumClusterwideEnvoyConfig  settings, you specified  max_pending_requests: 1  and  max_requests: 2 .\nThese rules indicate that if you exceed more than one connection and request concurrently,\nyou will see some failures when the envoy opens the circuit for further requests and connections. \n Tripping Envoy Circuit Breaker \n Make an environment variable with the Pod name for fortio: \n .. code-block:: shell-session \n $ export FORTIO_POD=$(kubectl get pods -l app=fortio -o 'jsonpath={.items[0].metadata.name}')\n \n Use the following command to call the Service with two concurrent connections using the  -c 2  flag and send 20 requests using  -n 20  flag: \n .. code-block:: shell-session \n $ kubectl exec \"$FORTIO_POD\" -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 http://echo-service:8080\n \n Output:: \n $ kubectl exec \"$FORTIO_POD\" -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 http://echo-service:8080\n{\"ts\":1692767216.838976,\"level\":\"info\",\"file\":\"scli.go\",\"line\":107,\"msg\":\"Starting Φορτίο 1.57.3 h1:kdPlBiws3cFsLcssZxCt2opFmHj14C3yPBokFhMWzmg= go1.20.6 amd64 linux\"}\nFortio 1.57.3 running at 0 queries per second, 4->4 procs, for 20 calls: http://echo-service:8080\n{\"ts\":1692767216.839520,\"level\":\"info\",\"file\":\"httprunner.go\",\"line\":100,\"msg\":\"Starting http test\",\"run\":\"0\",\"url\":\"http://echo-service:8080\",\"threads\":\"2\",\"qps\":\"-1.0\",\"warmup\":\"parallel\",\"conn-reuse\":\"\"}\nStarting at max qps with 2 thread(s) [gomax 4] for exactly 20 calls (10 per thread + 0)\n{\"ts\":1692767216.842149,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"1\",\"run\":\"0\"}\n{\"ts\":1692767216.854289,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T001 ended after 13.462339ms : 10 calls. qps=742.8129688310479\"}\n{\"ts\":1692767216.854985,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T000 ended after 14.158587ms : 10 calls. qps=706.2851681456631\"}\nEnded after 14.197088ms : 20 calls. qps=1408.7\n{\"ts\":1692767216.855035,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":564,\"msg\":\"Run ended\",\"run\":\"0\",\"elapsed\":\"14.197088ms\",\"calls\":\"20\",\"qps\":\"1408.739595049351\"}\nAggregated Function Time : count 20 avg 0.0013703978 +/- 0.000461 min 0.00092124 max 0.002696039 sum 0.027407957\n# range, mid point, percentile, count\n>= 0.00092124 <= 0.001 , 0.00096062 , 10.00, 2\n> 0.001 <= 0.002 , 0.0015 , 90.00, 16\n> 0.002 <= 0.00269604 , 0.00234802 , 100.00, 2\n# target 50% 0.0015\n# target 75% 0.0018125\n# target 90% 0.002\n# target 99% 0.00262644\n# target 99.9% 0.00268908\nError cases : count 1 avg 0.00133143 +/- 0 min 0.00133143 max 0.00133143 sum 0.00133143\n# range, mid point, percentile, count\n>= 0.00133143 <= 0.00133143 , 0.00133143 , 100.00, 1\n# target 50% 0.00133143\n# target 75% 0.00133143\n# target 90% 0.00133143\n# target 99% 0.00133143\n# target 99.9% 0.00133143\n# Socket and IP used for each connection:\n[0]   1 socket used, resolved to 10.96.182.43:8080, connection timing : count 1 avg 0.000426815 +/- 0 min 0.000426815 max 0.000426815 sum 0.000426815\n[1]   2 socket used, resolved to 10.96.182.43:8080, connection timing : count 2 avg 0.0004071275 +/- 0.0001215 min 0.000285596 max 0.000528659 sum 0.000814255\nConnection time histogram (s) : count 3 avg 0.00041369 +/- 9.966e-05 min 0.000285596 max 0.000528659 sum 0.00124107\n# range, mid point, percentile, count\n>= 0.000285596 <= 0.000528659 , 0.000407128 , 100.00, 3\n# target 50% 0.000346362\n# target 75% 0.00043751\n# target 90% 0.0004922\n# target 99% 0.000525013\n# target 99.9% 0.000528294\nSockets used: 3 (for perfect keepalive, would be 2)\nUniform: false, Jitter: false, Catchup allowed: true\nIP addresses distribution:\n10.96.182.43:8080: 3\nCode 200 : 19 (95.0 %)\nCode 503 : 1 (5.0 %)\nResponse Header Sizes : count 20 avg 370.5 +/- 85 min 0 max 390 sum 7410\nResponse Body/Total Sizes : count 20 avg 2340.15 +/- 465.7 min 310 max 2447 sum 46803\nAll done 20 calls (plus 0 warmup) 1.370 ms avg, 1408.7 qps\n \n From the above output, you can see that the response code of some requests is 503,\nwhich triggers a circuit breaker. \n Bring the number of concurrent connections up to 4. \n Output:: \n $ kubectl exec \"$FORTIO_POD\" -c fortio -- /usr/bin/fortio load -c 4 -qps 0 -n 20 http://echo-service:8080\n{\"ts\":1692767495.818546,\"level\":\"info\",\"file\":\"scli.go\",\"line\":107,\"msg\":\"Starting Φορτίο 1.57.3 h1:kdPlBiws3cFsLcssZxCt2opFmHj14C3yPBokFhMWzmg= go1.20.6 amd64 linux\"}\nFortio 1.57.3 running at 0 queries per second, 4->4 procs, for 20 calls: http://echo-service:8080\n{\"ts\":1692767495.819105,\"level\":\"info\",\"file\":\"httprunner.go\",\"line\":100,\"msg\":\"Starting http test\",\"run\":\"0\",\"url\":\"http://echo-service:8080\",\"threads\":\"4\",\"qps\":\"-1.0\",\"warmup\":\"parallel\",\"conn-reuse\":\"\"}\nStarting at max qps with 4 thread(s) [gomax 4] for exactly 20 calls (5 per thread + 0)\n{\"ts\":1692767495.822424,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"3\",\"run\":\"0\"}\n{\"ts\":1692767495.822428,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"0\",\"run\":\"0\"}\n{\"ts\":1692767495.822603,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"1\",\"run\":\"0\"}\n{\"ts\":1692767495.823855,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"0\",\"run\":\"0\"}\n{\"ts\":1692767495.825250,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"1\",\"run\":\"0\"}\n{\"ts\":1692767495.825285,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"0\",\"run\":\"0\"}\n{\"ts\":1692767495.827282,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"0\",\"run\":\"0\"}\n{\"ts\":1692767495.827514,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"2\",\"run\":\"0\"}\n{\"ts\":1692767495.829886,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"0\",\"run\":\"0\"}\n{\"ts\":1692767495.830156,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T000 ended after 9.136284ms : 5 calls. qps=547.268451812575\"}\n{\"ts\":1692767495.830326,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"2\",\"run\":\"0\"}\n{\"ts\":1692767495.831175,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"3\",\"run\":\"0\"}\n{\"ts\":1692767495.832826,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"3\",\"run\":\"0\"}\n{\"ts\":1692767495.834028,\"level\":\"warn\",\"file\":\"http_client.go\",\"line\":1104,\"msg\":\"Non ok http code\",\"code\":\"503\",\"status\":\"HTTP/1.1 503\",\"thread\":\"3\",\"run\":\"0\"}\n{\"ts\":1692767495.834116,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T003 ended after 13.09904ms : 5 calls. qps=381.7073617608619\"}\n{\"ts\":1692767495.834865,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T001 ended after 13.846811ms : 5 calls. qps=361.09397318992796\"}\n{\"ts\":1692767495.835370,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":832,\"msg\":\"T002 ended after 14.352324ms : 5 calls. qps=348.3756358900482\"}\nEnded after 14.386516ms : 20 calls. qps=1390.2\n{\"ts\":1692767495.835489,\"level\":\"info\",\"file\":\"periodic.go\",\"line\":564,\"msg\":\"Run ended\",\"run\":\"0\",\"elapsed\":\"14.386516ms\",\"calls\":\"20\",\"qps\":\"1390.1906479650806\"}\nAggregated Function Time : count 20 avg 0.0024801033 +/- 0.001782 min 0.000721482 max 0.008055527 sum 0.049602066\n# range, mid point, percentile, count\n>= 0.000721482 <= 0.001 , 0.000860741 , 10.00, 2\n> 0.001 <= 0.002 , 0.0015 , 45.00, 7\n> 0.002 <= 0.003 , 0.0025 , 80.00, 7\n> 0.003 <= 0.004 , 0.0035 , 85.00, 1\n> 0.005 <= 0.006 , 0.0055 , 95.00, 2\n> 0.008 <= 0.00805553 , 0.00802776 , 100.00, 1\n# target 50% 0.00214286\n# target 75% 0.00285714\n# target 90% 0.0055\n# target 99% 0.00804442\n# target 99.9% 0.00805442\nError cases : count 13 avg 0.0016602806 +/- 0.0006006 min 0.000721482 max 0.00281812 sum 0.021583648\n# range, mid point, percentile, count\n>= 0.000721482 <= 0.001 , 0.000860741 , 15.38, 2\n> 0.001 <= 0.002 , 0.0015 , 61.54, 6\n> 0.002 <= 0.00281812 , 0.00240906 , 100.00, 5\n# target 50% 0.00175\n# target 75% 0.00228634\n# target 90% 0.00260541\n# target 99% 0.00279685\n# target 99.9% 0.00281599\n# Socket and IP used for each connection:\n[0]   5 socket used, resolved to 10.96.182.43:8080, connection timing : count 5 avg 0.0003044688 +/- 0.0001472 min 0.000120654 max 0.00053878 sum 0.001522344\n[1]   3 socket used, resolved to 10.96.182.43:8080, connection timing : count 3 avg 0.00041437933 +/- 9.571e-05 min 0.000330279 max 0.000548277 sum 0.001243138\n[2]   3 socket used, resolved to 10.96.182.43:8080, connection timing : count 3 avg 0.00041114067 +/- 0.0001352 min 0.000306734 max 0.00060203 sum 0.001233422\n[3]   4 socket used, resolved to 10.96.182.43:8080, connection timing : count 4 avg 0.00038631225 +/- 0.0002447 min 0.000175125 max 0.00080311 sum 0.001545249\nConnection time histogram (s) : count 15 avg 0.0003696102 +/- 0.0001758 min 0.000120654 max 0.00080311 sum 0.005544153\n# range, mid point, percentile, count\n>= 0.000120654 <= 0.00080311 , 0.000461882 , 100.00, 15\n# target 50% 0.000437509\n# target 75% 0.000620309\n# target 90% 0.00072999\n# target 99% 0.000795798\n# target 99.9% 0.000802379\nSockets used: 15 (for perfect keepalive, would be 4)\nUniform: false, Jitter: false, Catchup allowed: true\nIP addresses distribution:\n10.96.182.43:8080: 15\nCode 200 : 7 (35.0 %)\nCode 503 : 13 (65.0 %)\nResponse Header Sizes : count 20 avg 136.5 +/- 186 min 0 max 390 sum 2730\nResponse Body/Total Sizes : count 20 avg 1026.9 +/- 1042 min 241 max 2447 sum 20538\nAll done 20 calls (plus 0 warmup) 2.480 ms avg, 1390.2 qps\n \n Now you can start to see the expected Circuit breaking behavior.\nOnly 35% of the requests succeeded and the rest were trapped by Circuit breaking. \n .. parsed-literal::\nCode 200 : 7 (35.0 %)\nCode 503 : 13 (65.0 %) \n Cleaning up \n Remove the rules. \n .. parsed-literal:: \n $ kubectl delete -f \\ |SCM_WEB|\\/examples/kubernetes/servicemesh/envoy/envoy-circuit-breaker.yaml\n \n Remove the test application. \n .. parsed-literal:: \n $ kubectl delete -f \\ |SCM_WEB|\\/examples/kubernetes/servicemesh/envoy/test-application-proxy-circuit-breaker.yaml",
  "item_type": "unknown",
  "module_path": "/tmp/cilium-repo/Documentation/network/servicemesh/envoy-circuit-breaker.rst",
  "extracted_at": "2025-09-03T01:13:29.145607Z"
}