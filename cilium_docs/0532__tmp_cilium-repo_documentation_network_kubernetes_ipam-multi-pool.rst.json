{
  "url": "file:///tmp/cilium-repo/Documentation/network/kubernetes/ipam-multi-pool.rst",
  "content": ".. only:: not (epub or latex or html)\n\n    WARNING: You are looking at unreleased Cilium documentation.\n    Please use the official rendered version released here:\n    http://docs.cilium.io\n\n.. _gsg_ipam_crd_multi_pool:\n\n*******************************************\nCRD-Backed by Cilium Multi-Pool IPAM (Beta)\n*******************************************\n\n.. include:: ../../beta.rst\n\nThis is a quick tutorial walking through how to enable multi-pool IPAM backed by the\n``CiliumPodIPPool`` CRD. The purpose of this tutorial is to show how components are configured and\nresources interact with each other to enable users to automate or extend on their own.\n\nFor more details, see the section :ref:`ipam_crd_multi_pool`\n\nEnable Multi-pool IPAM mode\n===========================\n\n#. Setup Cilium for Kubernetes using helm with the options:\n\n   * ``--set ipam.mode=multi-pool``\n   * ``--set kubeProxyReplacement=true``\n   * ``--set bpf.masquerade=true``\n\n   For more details on why each of these options are needed, please refer to\n   :ref:`ipam_crd_multi_pool_limitations`.\n\n#. Create the ``default`` pool for IPv4 addresses with the options:\n\n   * ``--set ipam.operator.autoCreateCiliumPodIPPools.default.ipv4.cidrs='{10.10.0.0/16}'``\n   * ``--set ipam.operator.autoCreateCiliumPodIPPools.default.ipv4.maskSize=27``\n\n#. Deploy Cilium and Cilium-Operator. Cilium will automatically wait until the\n   ``podCIDR`` is allocated for its node by Cilium Operator.\n\nValidate installation\n=====================\n\n#. Validate that Cilium has started up correctly\n\n   .. code-block:: shell-session\n\n       $ cilium status --wait\n           /¯¯\\\n        /¯¯\\__/¯¯\\    Cilium:             OK\n        \\__/¯¯\\__/    Operator:           OK\n        /¯¯\\__/¯¯\\    Envoy DaemonSet:    disabled (using embedded mode)\n        \\__/¯¯\\__/    Hubble Relay:       OK\n           \\__/       ClusterMesh:        disabled\n\n       [...]\n\n#. Validate that the ``CiliumPodIPPool`` resource for the ``default`` pool was created with the\n   CIDRs specified in the ``ipam.operator.autoCreateCiliumPodIPPools.default.*`` Helm values:\n\n   .. code-block:: shell-session\n\n       $ kubectl get ciliumpodippool default -o yaml\n       apiVersion: cilium.io/v2alpha1\n       kind: CiliumPodIPPool\n       metadata:\n         name: default\n       spec:\n         ipv4:\n           cidrs:\n           - 10.10.0.0/16\n           maskSize: 27\n\n#. Create an additional pod IP pool ``mars`` using the following ``CiliumPodIPPool`` resource:\n\n   .. code-block:: shell-session\n\n       $ cat <<EOF | kubectl apply -f -\n       apiVersion: cilium.io/v2alpha1\n       kind: CiliumPodIPPool\n       metadata:\n         name: mars\n       spec:\n         ipv4:\n           cidrs:\n           - 10.20.0.0/16\n           maskSize: 27\n       EOF\n\n#. Validate that both pool resources exist:\n\n   .. code-block:: shell-session\n\n       $ kubectl get ciliumpodippools\n       NAME      AGE\n       default   106s\n       mars      7s\n\n#. Create two deployments with two pods each. One allocating from the ``default`` pool and one\n   allocating from the ``mars`` pool by way of the ``ipam.cilium.io/ipam-pool: mars`` annotation:\n\n   .. code-block:: shell-session\n\n       $ cat <<EOF | kubectl apply -f -\n       apiVersion: apps/v1\n       kind: Deployment\n       metadata:\n         name: nginx-default\n       spec:\n         selector:\n           matchLabels:\n             app: nginx-default\n         replicas: 2\n         template:\n           metadata:\n             labels:\n               app: nginx-default\n           spec:\n             containers:\n             - name: nginx\n               image: nginx:1.25.1\n               ports:\n               - containerPort: 80\n       ---\n       apiVersion: apps/v1\n       kind: Deployment\n       metadata:\n         name: nginx-mars\n       spec:\n         selector:\n           matchLabels:\n             app: nginx-mars\n         replicas: 2\n         template:\n           metadata:\n             labels:\n               app: nginx-mars\n             annotations:\n               ipam.cilium.io/ip-pool: mars\n           spec:\n             containers:\n             - name: nginx\n               image: nginx:1.25.1\n               ports:\n               - containerPort: 80\n       EOF\n\n#. Validate that the pods were assigned IPv4 addresses from different CIDRs as specified in the pool\n   definition:\n\n   .. code-block:: shell-session\n\n       $ kubectl get pods -o wide\n       NAME                             READY   STATUS    RESTARTS   AGE    IP            NODE           NOMINATED NODE   READINESS GATES\n       nginx-default-79885c7f58-fdfgf   1/1     Running   0          5s     10.10.10.36   kind-worker2   <none>           <none>\n       nginx-default-79885c7f58-qch6b   1/1     Running   0          5s     10.10.10.77   kind-worker    <none>           <none>\n       nginx-mars-76766f95f5-d9vzt      1/1     Running   0          5s     10.20.0.20    kind-worker2   <none>           <none>\n       nginx-mars-76766f95f5-mtn2r      1/1     Running   0          5s     10.20.0.37    kind-worker    <none>           <none>\n\n#. Test connectivity between pods:\n\n   .. code-block:: shell-session\n\n       $ kubectl exec pod/nginx-default-79885c7f58-fdfgf -- curl -s -o /dev/null -w \"%{http_code}\" http://10.20.0.37\n       200\n\n#. Alternatively, the ``ipam.cilium.io/ipam-pool`` annotation can also be applied to a namespace:\n\n   .. code-block:: shell-session\n\n       $ kubectl create namespace cilium-test-1\n       $ kubectl annotate namespace cilium-test-1 ipam.cilium.io/ip-pool=mars\n\n   All new pods created in the namespace ``cilium-test-1`` will be assigned IPv4 addresses from the\n   ``mars`` pool.  Run the Cilium connectivity tests (which use namespace ``cilium-test-1`` by default\n   to create their workloads) to verify connectivity:\n\n   .. code-block:: shell-session\n\n       $ cilium connectivity test\n       [...]\n       ✅ All 42 tests (295 actions) successful, 13 tests skipped, 0 scenarios skipped.\n\n  **Note:** The connectivity test requires a cluster with at least 2 worker nodes to complete successfully.\n\n#. Verify that the connectivity test pods were assigned IPv4 addresses from the 10.20.0.0/16 CIDR\n   defined in the ``mars`` pool:\n\n   .. code-block:: shell-session\n\n       $ kubectl --namespace cilium-test get pods -o wide\n       NAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE                 NOMINATED NODE   READINESS GATES\n       client-6f6788d7cc-7fw9w               1/1     Running   0          8m56s   10.20.0.238   kind-worker          <none>           <none>\n       client2-bc59f56d5-hsv2g               1/1     Running   0          8m56s   10.20.0.193   kind-worker          <none>           <none>\n       echo-other-node-646976b7dd-5zlr4      2/2     Running   0          8m56s   10.20.1.145   kind-worker2         <none>           <none>\n       echo-same-node-58f99d79f4-4k5v4       2/2     Running   0          8m56s   10.20.0.202   kind-worker          <none>           <none>\n       ...\n",
  "item_type": "unknown",
  "module_path": "/tmp/cilium-repo/Documentation/network/kubernetes/ipam-multi-pool.rst",
  "extracted_at": "2025-09-03T01:13:29.242947Z"
}